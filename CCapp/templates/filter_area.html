<!-- base.htmlを継承 -->
{% extends "filter_base.html" %}

<!-- staticタグを使うために追加 -->
{% load static %}

<!-- filter_area用のタイトル -->
{% block title %}Filter Area{% endblock %}

<!-- 埋め込む用のcssを読み込む -->
{% block head2 %}
    <link href="{% static 'css/filter_area.css' %}" rel="stylesheet">
{% endblock %}

<!-- filter_base.htmlにぶち込む部分 -->
{% block content2 %}
    <!-- フォームの開始 -->
    <form method="GET" action="{% url 'CCapp:filter_area' %}" id="filterForm">
        <!-- 大分類ボタン -->
        <nav class="selection">
            <ul class="selection-button">
                {% for area0 in area0_list %}
                <li>
                    <a href="javascript:void(0);" onclick="showArea('area{{ area0.id }}')" aria-label="エリア {{ area0.name }}">
                        {{ area0.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </nav>

        <!-- 各エリアのチェックボックス -->
        <div class="checkbox-field">
            {% for area0 in area0_list %}
            <div id="area{{ area0.id }}" class="area-details {% if forloop.first %}active{% endif %}">
                <button type="button" onclick="selectAll('area{{ area0.id }}', true)">すべて選択</button>
                <button type="button" onclick="selectAll('area{{ area0.id }}', false)">選択解除</button>
                
                <!-- チェックボックスを動的に生成 -->
                {% for area1 in area1_list %}
                    {% if area1.area0_id == area0.id %}
                    <label>
                        <input type="checkbox" name="area1" value="{{ area1.id }}" 
                            {% if area1.id|stringformat:"s" in checked_areas %}checked{% endif %}>
                        {{ area1.name }}
                    </label><br>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- フォーム送信ボタン -->
        <button type="submit">検索</button>
    </form>

    <!-- 内部スクリプト -->
    <script>
        // ページ読み込み時に初期表示を設定
        window.onload = function() {
            restoreAreaState();
        };

        // ボタンをクリックしてチェックボックスを表示
        function showArea(areaId) {
            document.querySelectorAll('.area-details').forEach(area => {
                area.classList.toggle('active', area.id === areaId);
            });

            document.querySelectorAll('.selection-button a').forEach(button => {
                button.classList.remove('active');
            });

            const clickedButton = document.querySelector(`.selection-button a[onclick="showArea('${areaId}')"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }

        // すべて選択または解除
        function selectAll(areaId, isChecked) {
            const checkboxes = document.querySelectorAll(`#${areaId} input[type="checkbox"]`);
            checkboxes.forEach(checkbox => checkbox.checked = isChecked);
            saveAreaState();
        }

        // チェックボックスの状態をローカルストレージに保存
        function saveAreaState() {
            const filterState = {};
            document.querySelectorAll('input[type="checkbox"][name="area1"]').forEach(checkbox => {
                filterState[checkbox.value] = checkbox.checked || false;
            });
            localStorage.setItem('filterStates_area', JSON.stringify(filterState));
        }

        // チェックボックスの状態をローカルストレージから読み込み
        function restoreAreaState() {
            const filterState = JSON.parse(localStorage.getItem('filterStates_area') || '{}');
            document.querySelectorAll('input[type="checkbox"][name="area1"]').forEach(checkbox => {
                checkbox.checked = !!filterState[checkbox.value];
            });
        }

        // チェックボックスの変更時に保存
        document.querySelectorAll('input[type="checkbox"][name="area1"]').forEach(checkbox => {
            checkbox.addEventListener('change', saveAreaState);
        });
    </script>
{% endblock %}
